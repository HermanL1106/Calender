<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>電動機車工單系統</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 1000px; margin: auto; }
    label { display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 15px; padding: 10px 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 30px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top; }
    .service-items-container { margin-top: 10px; }
    .service-item-row { display: flex; gap: 10px; margin-top: 5px; }
    .service-item-row input { flex: 1; }
    .remove-item { background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    .action-buttons { display: flex; justify-content: center; gap: 10px; }
    th { position: sticky; top: 0; background: #f9f9f9; z-index: 1; }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container">
    <h1>電動機車工單系統</h1>

    <input type="file" id="importFile" accept=".csv">
    <button onclick="importWorkOrders()">匯入 CSV 工單</button>
    <button onclick="exportWorkOrders()">匯出工單 CSV</button>
    <button onclick="deleteSelectedOrders()">刪除所選工單</button>

    <div style="margin-top: 20px;">
      <input type="text" id="searchPlate" placeholder="搜尋車牌或工單編號">
      <label>起始日期：</label>
      <input type="date" id="startDate">
      <label>結束日期：</label>
      <input type="date" id="endDate">
      <button onclick="searchOrders()">搜尋</button>
      <button onclick="resetSearch()">重設</button>
    </div>

    <form id="workOrderForm">
      <input type="hidden" id="editIndex">
      <label>工單編號：</label>
      <input type="text" id="workOrderNumber" readonly>
      <label>車主姓名：</label>
      <input type="text" id="ownerName" required>
      <label>聯絡電話：</label>
      <input type="text" id="phoneNumber" required>
      <label>車牌號碼：</label>
      <input type="text" id="plateNumber" required>
      <label>里程數：</label>
      <input type="number" id="mileage" required>
      <label>維修項目：</label>
      <div id="serviceItems" class="service-items-container"></div>
      <button type="button" onclick="addServiceItem()">新增項目</button>
      <label>技師姓名：</label>
      <select id="technicianName" required>
        <option value="Kevin">Kevin</option>
        <option value="Hank">Hank</option>
      </select>
      <label>狀態：</label>
      <select id="status">
        <option value="待處理">待處理</option>
        <option value="處理中">處理中</option>
        <option value="已完成">已完成</option>
      </select>
      <label>日期：</label>
      <input type="date" id="orderDate" required>
      <div style="margin-top: 15px;">
        <button type="submit">儲存工單</button>
        <button type="button" onclick="resetForm()">重設</button>
      </div>
    </form>

    <table id="workOrderTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
          <th>工單編號</th>
          <th>車主</th>
          <th>電話</th>
          <th>車牌</th>
          <th>里程數</th>
          <th>維修項目</th>
          <th>總金額</th>
          <th>技師</th>
          <th>狀態</th>
          <th>日期</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyCJRG7xReo0_dx-ZaJhaUVIEU58JifmVAk",
      authDomain: "electric-bike-workorders.firebaseapp.com",
      projectId: "electric-bike-workorders",
      storageBucket: "electric-bike-workorders.firebasestorage.app",
      messagingSenderId: "41212869744",
      appId: "1:41212869744:web:be69af07e77e816efb88b5",
      measurementId: "G-V3VTZZ0T59"
    };

    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const db = firebase.firestore();

    let workOrders = JSON.parse(localStorage.getItem('workOrders') || '[]');

    document.getElementById('workOrderForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const index = document.getElementById('editIndex').value;
      const serviceItems = Array.from(document.querySelectorAll('.service-item-row')).map(row => {
        return {
          name: row.querySelector('.item-name').value.trim(),
          cost: parseFloat(row.querySelector('.item-cost').value)
        };
      });
      const totalAmount = serviceItems.reduce((sum, item) => sum + (item.cost || 0), 0);
      const newOrder = {
        workOrderNumber: document.getElementById('orderDate').value.replace(/-/g, '') + '-' + (index !== '' ? workOrders[index].workOrderNumber.split('-')[1] : (workOrders.length + 1).toString().padStart(3, '0')),
        ownerName: document.getElementById('ownerName').value.trim(),
        phoneNumber: document.getElementById('phoneNumber').value.trim(),
        plateNumber: document.getElementById('plateNumber').value.trim(),
        mileage: document.getElementById('mileage').value.trim(),
        serviceItems: serviceItems,
        technicianName: document.getElementById('technicianName').value,
        status: document.getElementById('status').value,
        date: document.getElementById('orderDate').value,
        totalAmount: totalAmount
      };
      if (index === '') {
        workOrders.push(newOrder);
      } else {
        workOrders[index] = newOrder;
      }
      saveToLocalStorage();
      displayWorkOrders(workOrders);

      // 同步到 Firebase
      db.collection("workOrders").doc(newOrder.workOrderNumber).set(newOrder)
      .then(() => {
        console.log("Firebase 儲存成功");
        alert("工單已同步到 Firebase！");
      })
      .catch((error) => {
        console.error("Firebase 儲存錯誤:", error);
        alert("儲存到 Firebase 時發生錯誤！");
      });

      this.reset();
      document.getElementById('serviceItems').innerHTML = '';
      document.getElementById('editIndex').value = '';
    });

    function resetForm() {
      document.getElementById('workOrderForm').reset();
      document.getElementById('serviceItems').innerHTML = '';
      document.getElementById('editIndex').value = '';
    }

    function addServiceItem(item = { name: '', cost: '' }) {
      const container = document.getElementById('serviceItems');
      const div = document.createElement('div');
      div.className = 'service-item-row';
      div.innerHTML = `
        <input type="text" class="item-name" placeholder="項目名稱" value="${item.name}">
        <input type="number" class="item-cost" placeholder="金額" value="${item.cost}">
        <button type="button" class="remove-item" onclick="this.parentElement.remove()">刪除</button>
      `;
      container.appendChild(div);
    }

    function displayWorkOrders(orders) {
      const tbody = document.querySelector('#workOrderTable tbody');
      tbody.innerHTML = '';
      orders.forEach((order, index) => {
        const items = order.serviceItems.map((item, i) => `${i + 1}. ${item.name}`).join('<br>');
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="checkbox" class="select-order" data-index="${index}"></td>
          <td>${order.workOrderNumber}</td>
          <td>${order.ownerName}</td>
          <td>${order.phoneNumber}</td>
          <td>${order.plateNumber}</td>
          <td>${order.mileage}</td>
          <td>${items}</td>
          <td>${order.totalAmount || 0}</td>
          <td>${order.technicianName}</td>
          <td>${order.status}</td>
          <td>${order.date}</td>
          <td>
            <div class="action-buttons">
              <button onclick="editWorkOrder(${index})">編輯</button>
              <button onclick="deleteWorkOrder(${index})">刪除</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function toggleSelectAll(source) {
      const checkboxes = document.querySelectorAll('.select-order');
      checkboxes.forEach(box => box.checked = source.checked);
    }

    function saveToLocalStorage() {
      localStorage.setItem('workOrders', JSON.stringify(workOrders));
    }

    // 從 Firebase 載入資料
    db.collection("workOrders").get().then((querySnapshot) => {
      workOrders = [];
      querySnapshot.forEach((doc) => {
        workOrders.push(doc.data());
      });
      saveToLocalStorage();
      displayWorkOrders(workOrders);
    }).catch((error) => {
      console.error("讀取 Firebase 發生錯誤: ", error);
      displayWorkOrders(workOrders); // 用本地的
    });
  </script>
</body>
</html>

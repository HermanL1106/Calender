<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>排班系統</title>
  <style>

th.top {
  position: sticky;
  top: 0;              /* 第一列貼頂 */
  background: #CAFFFF;
  z-index: 2;
}
/* 如果第二列也要跟著滾動並貼在第一列下方：*/
tr:nth-child(2) th {
  position: sticky;
  top: 40px;           /* 距離頂端 40px（和第一列高度一致） */
  background: #CAFFFF;
  z-index: 1;
}

	/* 1. 讓整張表格依內容自動分配欄寬 */
table {
  table-layout: auto;  /* 原本是 fixed，改成 auto */
}

/* 2. 移除 th,td 的固定寬度，只保留高度 */
th, td {
  border: 3px solid #000;
  text-align: center;
  padding: 4px;
  /* width: 40px;  ← 刪除此行 */
  height: 40px;
/* 加上這行，調整為你要的大小 */
  font-size: 20px;
}

/* 3. 只有非 sticky 的欄位仍維持 40px 寬 */
th:not(.sticky),
td:not(.sticky) {
  width: 40px;
}

/* 4. 第一欄 (員工姓名) 自動寬度、不換行 */
th.sticky,
td.sticky {
  position: sticky;
  left: 0;
  background: #CAFFFF;
  z-index: 1;
  white-space: nowrap;
  overflow: visible;
  max-width: none;
}
	/* palette 按鈕 */
button.rest-red         { background:#f44336; color:#fff; }
button.rest-lightblue   { background:#b3e5fc; color:#000; }
button.sick             { background:#006400; color:#fff; }
button.special          { background:#03a9f4; color:#fff; }
button.personal         { background:#ffeb3b; color:#000; }
button.training         { background:#9c27b0; color:#fff; }
button.work             { background:#ffffff; color:#000; }
/* 在原本的 button 顏色區塊後面加上 */
button.special-hour {background: #003366;color: #fff;}
/* 同步 td 樣式 */
td.special-hour {background: #003366;color: #fff;}
/* CSS：加在现有 button & td 样式后面 */
button.personal-hour { background: #ff9800; color: #fff; }
td.personal-hour     { background: #ff9800; color: #fff; }

button.sick-hour     { background: #004d00; color: #fff; }
td.sick-hour         { background: #004d00; color: #fff; }

/* 按鈕共用樣式 */
#palette button {
  border:none;
  padding:6px 12px;
  margin-right:4px;
  cursor:pointer;
  border-radius:4px;
}
#palette button.active {
  outline:2px solid #000;
}

/* 班表格子的顏色 */
td.rest-red         { background: #f44336; color: #fff; }
td.rest-lightblue   { background: #b3e5fc; color: #000; }
td.sick             { background: #006400; color: #fff; }
td.special          { background: #03a9f4; color: #fff; }
td.personal         { background: #ffeb3b; color: #000; }
td.training         { background: #9c27b0; color: #fff; }
td.work             { background: #fff;    color: #000; }

  </style>
</head>
<body>
  <h2 id="monthDisplay">2025/03</h2>
  <label>年份：<input type="number" id="yearInput" value="2025"></label>
  <label>月份：<input type="number" id="monthInput" value="3" min="1" max="12"></label>
  <button onclick="generateTable()">更新</button>
<div>
  <button id="addEmpBtn">新增員工</button>
  <button id="removeEmpBtn">刪除員工</button>
  <button id="resetAllBtn">全部上班</button>
	 <button id="unlockBtn">解鎖</button> 
</div>
<!-- 顏色按鈕群 -->
<div id="palette" style="margin:8px 0;">
  <!-- 按鈕會由下面 JS 自動產生 -->
</div>

  <table id="scheduleTable">
    <!-- 生成的表格會插入這裡 -->
  </table>
<script>
  let locked = true;

  // —— localStorage helpers —— 
  function loadEmployees() {
    return JSON.parse(localStorage.getItem('employees') || '[]');
  }
  function saveEmployees() {
    localStorage.setItem('employees', JSON.stringify(employees));
  }
  function loadRemovedEmployees() {
    return JSON.parse(localStorage.getItem('removedEmployees') || '[]');
  }
  function saveRemovedEmployees() {
    localStorage.setItem('removedEmployees', JSON.stringify(removedEmployees));
  }
  function loadScheduleData() {
    scheduleData = JSON.parse(localStorage.getItem('scheduleData') || '{}');
  }
  function saveScheduleData() {
    localStorage.setItem('scheduleData', JSON.stringify(scheduleData));
  }
  function getCellKey(year, month, emp, day) {
    const mm = String(month).padStart(2,'0');
    const dd = String(day).padStart(2,'0');
    return `${year}-${mm}-${emp}-${dd}`;
  }

  // —— 初始載入 & 資料結構 —— 
  let employees = loadEmployees();
  if (employees.length === 0) {
    employees = ["李育豪","盧泰勳","洪嘉偉","李冠勳","陳科錞","郎偉翔","吳柏承","陳君豪","許庭凱"];
    saveEmployees();
  }
  let removedEmployees = loadRemovedEmployees();
  let scheduleData = {};

  // —— 調色盤設定 —— 
  const palette = [
    { code:'休', cls:'rest-red' },
    { code:'休', cls:'rest-lightblue' },
    { code:'病', cls:'sick' },
    { code:'特', cls:'special' },
    { code:'事', cls:'personal' },
    { code:'訓', cls:'training' },
    { code:null, cls:'sick-hour',     hourlyType:'病' },
    { code:null, cls:'personal-hour', hourlyType:'事' },
    { code:null, cls:'special-hour',  hourlyType:'特' },
    { code:'●', cls:'work' }
  ];
  let currentTool = palette.find(p => p.code === '●');

  function initPalette() {
    const div = document.getElementById('palette');
    div.innerHTML = '';
    palette.forEach(item => {
      const btn = document.createElement('button');
      btn.classList.add(item.cls);
      btn.textContent = item.hourlyType ? `${item.hourlyType}×H` : item.code;
      btn.addEventListener('click', () => {
        div.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (item.hourlyType) {
          const h = prompt(`請輸入要記錄的${item.hourlyType}休小時數（整數）`, '3');
          if (!h || isNaN(h)) return alert('請輸入數字');
          currentTool = { code:`${item.hourlyType}${Math.floor(h)}H`, cls:item.cls };
        } else {
          currentTool = item;
        }
      });
      div.appendChild(btn);
    });
    div.querySelector('button.work')?.classList.add('active');
  }

  // —— 點格套用 & 儲存 —— 
  function attachCellClick() {
    document.querySelectorAll('#scheduleTable td[contenteditable]').forEach(td => {
      td.onclick = () => {
        td.textContent = currentTool.code;
        td.classList.remove(...palette.map(p => p.cls));
        td.classList.add(currentTool.cls);
        const year  = parseInt(document.getElementById('yearInput').value, 10);
        const month = parseInt(document.getElementById('monthInput').value, 10);
        const key   = getCellKey(year, month, td.dataset.emp, td.dataset.day);
        scheduleData[key] = currentTool.code;
        saveScheduleData();
      };
    });
  }

  // —— 生成功能表格 —— 
  function generateTable() {
    removedEmployees = loadRemovedEmployees();
    loadScheduleData();

    const year  = parseInt(document.getElementById('yearInput').value, 10);
    const month = parseInt(document.getElementById('monthInput').value, 10);
    document.getElementById('monthDisplay').textContent = `${year}/${String(month).padStart(2,'0')}`;

    const table = document.getElementById('scheduleTable');
    table.innerHTML = '';
    const daysInMonth = new Date(year, month, 0).getDate();

    // — 首列：日期 + 統計標題 —
    const headerRow1 = document.createElement('tr');
    const thA1 = document.createElement('th');
    thA1.classList.add('top','sticky');
    thA1.textContent = '員工';
    headerRow1.appendChild(thA1);
    for (let d = 1; d <= daysInMonth; d++) {
      const th = document.createElement('th');
      th.classList.add('top');
      th.textContent = d;
      headerRow1.appendChild(th);
    }
    ['例休','特休','病假','事假'].forEach(text => {
      const th = document.createElement('th');
      th.classList.add('top');
      th.textContent = text;
      headerRow1.appendChild(th);
    });
    table.appendChild(headerRow1);

    // — 次列：星期 + 空白 —
    const headerRow2 = document.createElement('tr');
    const thEmpty = document.createElement('th');
    thEmpty.classList.add('top','sticky');
    headerRow2.appendChild(thEmpty);
    for (let d = 1; d <= daysInMonth; d++) {
      const wd = new Date(year, month - 1, d).getDay();
      const wdStr = ['日','一','二','三','四','五','六'][wd];
      const th = document.createElement('th');
      th.classList.add('top');
      th.textContent = `週${wdStr}`;
      headerRow2.appendChild(th);
    }
    for (let i = 0; i < 4; i++) {
      const th = document.createElement('th');
      th.classList.add('top');
      headerRow2.appendChild(th);
    }
    table.appendChild(headerRow2);

    // — 員工列 + 統計 —
    const displayEmps = employees.filter(emp => {
      const recs = removedEmployees.filter(r => r.name === emp);
      if (recs.length === 0) return true;
      recs.sort((a,b) => (a.year - b.year) || (a.month - b.month));
      const rec = recs[0];
      return year < rec.year || (year === rec.year && month < rec.month);
    });

    displayEmps.forEach(emp => {
      const tr = document.createElement('tr');
      // 姓名
      const tdName = document.createElement('td');
      tdName.classList.add('sticky');
      tdName.textContent = emp;
      tdName.style.cursor = locked ? 'default' : 'text';
      if (!locked) tdName.contentEditable = true;
      tr.appendChild(tdName);

      // 每天
      for (let d = 1; d <= daysInMonth; d++) {
        const td = document.createElement('td');
        td.dataset.emp = emp;
        td.dataset.day = d;
        const key = getCellKey(year, month, emp, d);
        const code = scheduleData[key] || '●';
        td.textContent = code;
        let tool = palette.find(p => p.code === code);
        if (!tool) {
          const m = code.match(/^([病特事])(\d+)H$/);
          if (m) tool = palette.find(p => p.hourlyType === m[1]);
        }
        td.classList.add((tool||palette.find(p=>p.code==='●')).cls);
        td.contentEditable = !locked;
        td.style.cursor    = locked ? 'default' : 'text';
        tr.appendChild(td);
      }

      // 統計
      let cntRest=0, cntSpec=0, cntSick=0, cntPers=0;
      for (let d = 1; d <= daysInMonth; d++) {
        const key  = getCellKey(year, month, emp, d);
        const code = scheduleData[key] || '';
        if (code==='休') cntRest++;
        if (code==='特') cntSpec++;
        if (code==='病') cntSick++;
        if (code==='事') cntPers++;
      }
      [cntRest, cntSpec, cntSick, cntPers].forEach(c => {
        const td = document.createElement('td');
        td.textContent = c;
        tr.appendChild(td);
      });

      table.appendChild(tr);
    });

    // — 上班人數 —
    const trCount = document.createElement('tr');
    const tdLabel = document.createElement('td');
    tdLabel.classList.add('sticky');
    tdLabel.textContent = '上班人數';
    trCount.appendChild(tdLabel);
    for (let d = 1; d <= daysInMonth; d++) {
      let cnt = 0;
      for (let r = 2; r < table.rows.length; r++) {
        if (table.rows[r].cells[d].classList.contains('work')) cnt++;
      }
      const tdCount = document.createElement('td');
      tdCount.textContent = cnt;
      tdCount.style.fontWeight = 'bold';
      trCount.appendChild(tdCount);
    }
    table.appendChild(trCount);

    if (!locked) attachCellClick();
  }

  window.addEventListener('DOMContentLoaded', () => {
 // —— 自動設置到當前年月 —— 
    const today = new Date();
    document.getElementById('yearInput').value  = today.getFullYear();
    document.getElementById('monthInput').value = today.getMonth() + 1;    
// 初始化
    initPalette();
    generateTable();

    const addBtn    = document.getElementById('addEmpBtn');
    const removeBtn = document.getElementById('removeEmpBtn');
    const resetBtn  = document.getElementById('resetAllBtn');
    const unlockBtn = document.getElementById('unlockBtn');




    // 初始禁用
    [addBtn, removeBtn, resetBtn].forEach(b => b.disabled = locked);

    // 解鎖
    unlockBtn.addEventListener('click', () => {
      const pw = prompt('請輸入解鎖密碼','');
      if (pw === '123') {
        locked = false;
        [addBtn, removeBtn, resetBtn].forEach(b => b.disabled = false);
        alert('已解鎖，可以編輯了');
        generateTable();
      } else {
        alert('密碼錯誤');
      }
    });

    // 新增員工
    addBtn.addEventListener('click', () => {
      if (locked) return alert('請先解鎖才能新增員工');
      const name = prompt('請輸入新員工名稱：')?.trim();
      if (!name) return;
      removedEmployees = removedEmployees.filter(r => r.name !== name);
      saveRemovedEmployees();
      if (!employees.includes(name)) {
        employees.push(name);
        saveEmployees();
      } else {
        alert('員工已存在');
      }
      generateTable();
    });

    // 刪除員工
    removeBtn.addEventListener('click', () => {
      if (locked) return alert('請先解鎖才能刪除員工');
      const name = prompt('請輸入欲刪除的員工名稱：')?.trim();
      if (!name || !employees.includes(name)) {
        return alert('找不到此員工');
      }
      const year  = parseInt(document.getElementById('yearInput').value,10);
      const month = parseInt(document.getElementById('monthInput').value,10);
      removedEmployees.push({ name, year, month });
      saveRemovedEmployees();
      loadScheduleData();
      Object.keys(scheduleData).forEach(key => {
        const [ky, km, ...rest] = key.split('-');
        const emp = rest.slice(0,-1).join('-');
        if (emp===name && (+ky>year || (+ky===year && +km>=month))) {
          delete scheduleData[key];
        }
      });
      saveScheduleData();
      generateTable();
    });

    // 全部上班
    resetBtn.addEventListener('click', () => {
      if (locked) return alert('請先解鎖才能全部上班');
      const year  = parseInt(document.getElementById('yearInput').value,10);
      const month = parseInt(document.getElementById('monthInput').value,10);
      const daysInMonth = new Date(year, month, 0).getDate();
      const displayEmps = employees.filter(emp => {
        const recs = removedEmployees.filter(r=>r.name===emp);
        if (!recs.length) return true;
        recs.sort((a,b)=>(a.year-b.year)||(a.month-b.month));
        const rec = recs[0];
        return year<rec.year||(year===rec.year&&month<rec.month);
      });
      displayEmps.forEach(emp => {
        for (let d=1; d<=daysInMonth; d++) {
          const key = getCellKey(year, month, emp, d);
          scheduleData[key] = '●';
        }
      });
      saveScheduleData();
      generateTable();
    });

    // 年/月 切換
    document.getElementById('yearInput').addEventListener('change', generateTable);
    document.getElementById('monthInput').addEventListener('change', generateTable);
  });
</script>



</body>
</html>
